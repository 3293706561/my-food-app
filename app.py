import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import os
import requests
from fpdf import FPDF

# --- 1. AI è¥å…»åˆ†æé€»è¾‘ ---
def get_ai_advice(food_name, protein, fat, region):
    api_url = "https://api.deepseek.com/chat/completions"
    try:
        api_key = st.secrets["DEEPSEEK_API_KEY"]
    except:
        return "è¯·åœ¨ Streamlit Secrets ä¸­é…ç½® API Key ğŸ”‘"
    
    prompt = f"""
    ä½ æ˜¯ä¸€ä½ç²¾é€šä¸­å›½é¥®é£Ÿæ–‡åŒ–çš„è¥å…»ä¸“å®¶ã€‚
    å½“å‰é£Ÿç‰©ï¼š{food_name}ï¼ˆè›‹ç™½è´¨ï¼š{protein}gï¼Œè„‚è‚ªï¼š{fat}gï¼‰ã€‚
    ç”¨æˆ·æ‰€åœ¨åœ°åŸŸï¼š{region}ã€‚
    è¯·æä¾›ï¼š
    1. ã€åœ°åŸŸæº¯æºã€‘ï¼šè¯¥é£Ÿç‰©åœ¨ä¸­å›½çš„ä¸»è¦äº§åœ°æˆ–åœ°æ ‡ã€‚
    2. ã€äººç¾¤ä¹ æƒ¯ã€‘ï¼šé’ˆå¯¹{region}äººç¾¤çš„å¥åº·å»ºè®®ã€‚
    3. ã€è¥å…»è¯„ä»·ã€‘ï¼šä¸€å¥è¯æ€»ç»“ã€‚
    æ³¨æ„ï¼šè¯·ç”¨ç®€æ´çš„ä¸­æ–‡å›ç­”ï¼Œä¸è¦è¶…è¿‡150å­—ã€‚
    """
    
    headers = {"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"}
    data = {
        "model": "deepseek-chat",
        "messages": [{"role": "user", "content": prompt}],
        "temperature": 0.7
    }
    try:
        response = requests.post(api_url, json=data, headers=headers, timeout=15)
        return response.json()['choices'][0]['message']['content']
    except:
        return "AI è¥å…»å¸ˆæ­£åœ¨æŸ¥çœ‹åœ°æ–¹å¿—ï¼Œè¯·ç¨åå†è¯•..."

# --- 2. å¢å¼ºç‰ˆ PDF æŠ¥å‘Šç”Ÿæˆ (æ›´ç¾è§‚) ---
def create_pdf_report(name, p, f, advice, region):
    pdf = FPDF()
    pdf.add_page()
    
    # é¡µçœ‰ï¼šè–„è·ç»¿èƒŒæ™¯
    pdf.set_fill_color(46, 204, 113) 
    pdf.rect(0, 0, 210, 40, 'F')
    
    # æ ‡é¢˜
    pdf.set_text_color(255, 255, 255)
    pdf.set_font("Arial", 'B', 24)
    pdf.cell(0, 20, "Nutrition Analysis Report", ln=True, align='C')
    pdf.ln(10)
    
    # ä¸»ä½“å†…å®¹
    pdf.set_text_color(0, 0, 0)
    pdf.set_font("Arial", 'B', 14)
    pdf.cell(0, 10, f"Target Food: {name}", ln=True)
    pdf.set_draw_color(46, 204, 113)
    pdf.line(10, pdf.get_y(), 200, pdf.get_y()) # ç»¿è‰²åˆ†å‰²çº¿
    pdf.ln(5)
    
    # æ•°æ®å±•ç¤º
    pdf.set_font("Arial", size=12)
    pdf.cell(0, 10, f"Region Context: {region}", ln=True)
    pdf.cell(50, 10, f"Protein: {p}g")
    pdf.cell(50, 10, f"Fat: {f}g", ln=True)
    pdf.ln(5)
    
    # AI å»ºè®®æ¿å—
    pdf.set_fill_color(245, 245, 245)
    pdf.set_font("Arial", 'B', 13)
    pdf.cell(0, 10, " AI Coach Advice (Summary):", ln=True, fill=True)
    pdf.ln(2)
    pdf.set_font("Arial", size=11)
    
    # å¤„ç†ä¸­æ–‡ä¹±ç ï¼šç›®å‰ FPDF é»˜è®¤ä¸æ”¯æŒä¸­æ–‡ï¼ŒPDF å†…éƒ¨å»ºè®®å…ˆæ˜¾ç¤ºè‹±æ–‡æ‘˜è¦
    # å¦‚æœ AI è¿”å›ä¸­æ–‡ï¼ŒPDF æ‰“å°æ—¶ä¼šç•¥è¿‡é Latin å­—ç¬¦ï¼Œæˆ‘ä»¬æç¤ºç”¨æˆ·çœ‹ç½‘é¡µè¯¦ç»†ç‰ˆ
    clean_advice = advice.encode('latin-1', 'ignore').decode('latin-1')
    if not clean_advice.strip():
        clean_advice = "The full Chinese report is available on the website. [AI Analysis Completed]"
        
    pdf.multi_cell(0, 8, txt=clean_advice)
    
    # é¡µè„š
    pdf.set_y(-20)
    pdf.set_font("Arial", 'I', 8)
    pdf.cell(0, 10, "Generated by Gemini-Powered AI Nutrition Lab", align='C')
    
    return pdf.output(dest='S').encode('latin-1')

# --- 3. Streamlit é¡µé¢å¸ƒå±€ ---
st.set_page_config(page_title="AI è¥å…»å®éªŒå®¤", layout="wide")
st.title("ğŸ¥— AI æ™ºèƒ½è¥å…»å®éªŒå®¤")

# ä¾§è¾¹æ 
st.sidebar.header("ğŸŒ åœ°åŸŸè®¾å®š")
user_region = st.sidebar.selectbox(
    "æ‚¨çš„é¥®é£Ÿä¹ æƒ¯ä¹ æƒ¯ï¼š",
    ["å·æ¸åœ°åŒº (Heavy Spice)", "åŒ—æ–¹åœ°åŒº (High Salt/Carb)", "å¹¿ä¸œåœ°åŒº (Light/Herbal)", "æ±Ÿæµ™æ²ª (Sweet/Fresh)", "è¥¿åŒ—åœ°åŒº (Meat/Noodle)"]
)

# åŠ è½½æ•°æ®
csv_path = 'protein_vs_fat.csv'
if os.path.exists(csv_path):
    df = pd.read_csv(csv_path)
    search_term = st.text_input("ğŸ” æœç´¢é£Ÿç‰©åç§° (è‹±æ–‡):", "Chicken")
    
    filtered_df = df[df['Food_Name'].str.contains(search_term, case=False)]
    
    if not filtered_df.empty:
        top_food = filtered_df.iloc[0]
        
        # å·¦å³å¸ƒå±€
        col1, col2 = st.columns([1, 1])
        
        with col1:
            st.subheader("ğŸ“Š è¥å…»æ•°æ®ä¸ AI å»ºè®®")
            
            # ä¼˜åŒ–åçš„æŒ‡æ ‡æ˜¾ç¤ºï¼Œä¸å†é‡å¤
            m1, m2 = st.columns(2)
            m1.metric("è›‹ç™½è´¨ (Protein)", f"{top_food['Protein_Value']}g")
            m2.metric("è„‚è‚ª (Fat)", f"{top_food['Fat_Value']}g")
            
            # AI åˆ†æ
            with st.spinner('AI æ­£åœ¨ç»“åˆåœ°åŸŸä¹ æƒ¯åˆ†æä¸­...'):
                advice = get_ai_advice(top_food['Food_Name'], top_food['Protein_Value'], top_food['Fat_Value'], user_region)
            
            st.info(f"**AI å»ºè®® ({user_region}):**\n\n{advice}")
            
            # æ¼‚äº®æŠ¥å‘Šä¸‹è½½æŒ‰é’®
            pdf_bytes = create_pdf_report(top_food['Food_Name'], top_food['Protein_Value'], top_food['Fat_Value'], advice, user_region)
            st.download_button(
                label="ğŸ“¥ ä¸‹è½½ç²¾ç¾è¥å…»æŠ¥å‘Š (PDF)",
                data=pdf_bytes,
                file_name=f"Nutrition_Report_{top_food['Food_Name']}.pdf",
                mime="application/pdf"
            )

        with col2:
            st.subheader("ğŸ”¥ èƒ½é‡é…æ¯”å›¾")
            fig, ax = plt.subplots(figsize=(6, 6))
            # è®¡ç®—çƒ­é‡æ¯”ä¾‹
            p_cal = top_food['Protein_Value'] * 4
            f_cal = top_food['Fat_Value'] * 9
            ax.pie([p_cal, f_cal], labels=['Protein', 'Fat'], autopct='%1.1f%%', colors=['#2ecc71', '#e67e22'], startangle=140)
            st.pyplot(fig)
    else:
        st.warning("æœªæ‰¾åˆ°åŒ¹é…é£Ÿç‰©ï¼Œè¯·æ¢ä¸ªè¯è¯•è¯•ã€‚")
else:
    st.error("æ‰¾ä¸åˆ°æ•°æ®åº“æ–‡ä»¶ protein_vs_fat.csvï¼Œè¯·æ£€æŸ¥è·¯å¾„ã€‚")

