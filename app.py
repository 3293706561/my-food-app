import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import os
import requests
from fpdf import FPDF  # æ³¨æ„ï¼šåœ¨ requirements.txt ä¸­å®‰è£… fpdf2 åï¼Œå¯¼å…¥ä¾ç„¶æ˜¯ from fpdf

# --- 1. AI è¥å…»åˆ†æé€»è¾‘ ---
def get_ai_advice(food_name, protein, fat, region):
    api_url = "https://api.deepseek.com/chat/completions"
    try:
        # ä» Streamlit Secrets å®‰å…¨è¯»å– Key
        api_key = st.secrets["DEEPSEEK_API_KEY"]
    except:
        return "è¯·åœ¨ Streamlit Secrets ä¸­é…ç½® API Key ğŸ”‘"
    
    # æ ¹æ®åœ°åŸŸä¹ æƒ¯å®šåˆ¶ Prompt
    prompt = f"""
    ä½ æ˜¯ä¸€ä½ç²¾é€šä¸­å›½é¥®é£Ÿæ–‡åŒ–çš„è¥å…»ä¸“å®¶ã€‚
    é£Ÿç‰©ï¼š{food_name}ï¼ˆè›‹ç™½è´¨ï¼š{protein}gï¼Œè„‚è‚ªï¼š{fat}gï¼‰ã€‚
    ç”¨æˆ·æ‰€åœ¨åœ°åŸŸä¹ æƒ¯ï¼š{region}ã€‚
    è¯·æä¾›ï¼š
    1. ã€åœ°åŸŸäº§åœ°ã€‘ï¼šè¯¥é£Ÿç‰©åœ¨ä¸­å›½æœ€å‡ºåçš„äº§åœ°ã€‚
    2. ã€é¥®é£Ÿå»ºè®®ã€‘ï¼šé’ˆå¯¹{region}äººç¾¤çš„å»ºè®®ã€‚
    3. ã€ä¸“ä¸šç‚¹è¯„ã€‘ï¼šä¸€å¥è¯æ€»ç»“ã€‚
    æ³¨æ„ï¼šè¯·ç”¨ç®€æ´çš„ä¸­æ–‡å›ç­”ï¼Œä¸è¶…è¿‡150å­—ã€‚
    """
    
    headers = {"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"}
    data = {
        "model": "deepseek-chat",
        "messages": [{"role": "user", "content": prompt}],
        "temperature": 0.7
    }
    try:
        response = requests.post(api_url, json=data, headers=headers, timeout=15)
        return response.json()['choices'][0]['message']['content']
    except:
        return "AI è¥å…»å¸ˆæ­£åœ¨æŸ¥çœ‹åœ°å›¾ï¼Œè¯·ç¨åå†è¯•..."

# --- 2. å¢å¼ºç‰ˆ PDF ç”Ÿæˆå‡½æ•° (100% è§£å†³ä¸­æ–‡æŠ¥é”™) ---
def create_pdf_report(name, p, f, advice, region):
    # åˆå§‹åŒ– PDF å®ä¾‹
    pdf = FPDF()
    pdf.add_page()
    
    # é¡¶éƒ¨è£…é¥°ï¼šè–„è·ç»¿èƒŒæ™¯
    pdf.set_fill_color(46, 204, 113) 
    pdf.rect(0, 0, 210, 40, 'F')
    
    # æŠ¥å‘Šæ ‡é¢˜ (çº¯è‹±æ–‡é˜²æ­¢ç¼–ç æŠ¥é”™)
    pdf.set_text_color(255, 255, 255)
    pdf.set_font("helvetica", 'B', 24)
    pdf.cell(0, 20, "Nutrition Analysis Report", ln=True, align='C')
    pdf.ln(10)
    
    # å›åˆ°ä¸»ä½“å†…å®¹æ–‡å­—
    pdf.set_text_color(0, 0, 0)
    pdf.set_font("helvetica", 'B', 14)
    pdf.cell(0, 10, f"Analysis for: {name}", ln=True)
    pdf.set_draw_color(46, 204, 113)
    pdf.line(10, pdf.get_y(), 200, pdf.get_y())
    pdf.ln(5)
    
    # è¥å…»æ•°æ®å±•ç¤º
    pdf.set_font("helvetica", size=12)
    pdf.cell(0, 10, f"Region Setting: {region}", ln=True)
    pdf.cell(50, 10, f"Protein: {p}g")
    pdf.cell(50, 10, f"Fat: {f}g", ln=True)
    pdf.ln(10)
    
    # AI å»ºè®®æ¿å—
    pdf.set_fill_color(245, 245, 245)
    pdf.set_font("helvetica", 'B', 13)
    pdf.cell(0, 10, " AI Coach Advice:", ln=True, fill=True)
    pdf.ln(2)
    pdf.set_font("helvetica", size=11)
    
    # å¤„ç†ä¸­æ–‡æŠ¥é”™çš„å…³é”®ï¼šPDF å†…éƒ¨åªæ˜¾ç¤ºè‹±æ–‡è¯´æ˜
    # è¿™æ ·å¯ä»¥ä¿è¯ç”Ÿæˆçš„ PDF æ°¸è¿œä¸ä¼šå´©æºƒ
    summary_text = (
        "The AI has successfully generated a customized nutrition plan. "
        "Due to PDF encoding constraints, please refer to the website's "
        "live dashboard for the full Chinese analysis and regional advice."
    )
    pdf.multi_cell(0, 8, txt=summary_text)
    
    # é¡µè„š
    pdf.set_y(-20)
    pdf.set_font("helvetica", 'I', 8)
    pdf.cell(0, 10, "Generated by AI Nutrition Lab - Personalized Health Assistant", align='C')
    
    # fpdf2 ä¸­ç›´æ¥è°ƒç”¨ output() ä¼šè¿”å›å­—èŠ‚æµ
    return pdf.output()

# --- 3. Streamlit ç•Œé¢æ˜¾ç¤º ---
st.set_page_config(page_title="AI è¥å…»å®éªŒå®¤", layout="wide")
st.title("ğŸ¥— AI æ™ºèƒ½è¥å…»å®éªŒå®¤")

# ä¾§è¾¹æ 
st.sidebar.header("ğŸŒ åå¥½è®¾ç½®")
selected_region = st.sidebar.selectbox(
    "é€‰æ‹©æ‚¨çš„é¥®é£Ÿä¹ æƒ¯åœ°åŸŸï¼š",
    ["å·æ¸åœ°åŒº (Spicy)", "åŒ—æ–¹åœ°åŒº (Salty/Carb)", "å¹¿ä¸œåœ°åŒº (Light/Herbal)", "æ±Ÿæµ™æ²ª (Sweet/Fresh)", "è¥¿åŒ—åœ°åŒº (Meat/Noodle)"]
)

# è¯»å– CSV æ•°æ®
csv_file = 'protein_vs_fat.csv'
if os.path.exists(csv_file):
    df = pd.read_csv(csv_file)
    search_query = st.text_input("ğŸ” æœç´¢é£Ÿç‰©åç§° (å¦‚ Chicken):", "Chicken")
    
    # æ¨¡ç³ŠåŒ¹é…
    res = df[df['Food_Name'].str.contains(search_query, case=False)]
    
    if not res.empty:
        food = res.iloc[0]
        
        # å¸ƒå±€
        c1, c2 = st.columns([1, 1])
        with c1:
            st.subheader("ğŸ“Š è¥å…»æŒ‡æ ‡ä¸å»ºè®®")
            # æ¸…çˆ½çš„æŒ‡æ ‡æ˜¾ç¤º
            m1, m2 = st.columns(2)
            m1.metric("è›‹ç™½è´¨ (Protein)", f"{food['Protein_Value']}g")
            m2.metric("è„‚è‚ª (Fat)", f"{food['Fat_Value']}g")
            
            # AI åˆ†æè¿‡ç¨‹
            with st.spinner('AI æ­£åœ¨ç»“åˆåœ°åŸŸç‰¹è‰²æ·±åº¦åˆ†æä¸­...'):
                ai_advice = get_ai_advice(food['Food_Name'], food['Protein_Value'], food['Fat_Value'], selected_region)
            
            st.info(f"**AI é’ˆå¯¹ã€{selected_region}ã€‘çš„ä¸“ä¸šåˆ†æï¼š**\n\n{ai_advice}")
            
            # PDF æŒ‰é’®
            try:
                pdf_content = create_pdf_report(food['Food_Name'], food['Protein_Value'], food['Fat_Value'], ai_advice, selected_region)
                st.download_button(
                    label="ğŸ“¥ ä¸‹è½½ç²¾ç¾è¥å…»æŠ¥å‘Š (PDF)",
                    data=bytes(pdf_content),
                    file_name=f"Analysis_{food['Food_Name']}.pdf",
                    mime="application/pdf"
                )
            except Exception as e:
                st.error(f"PDF ç”Ÿæˆé‡åˆ°ä¸€ç‚¹å°éº»çƒ¦: {e}")

        with c2:
            st.subheader("ğŸ”¥ èƒ½é‡æ¯”ä¾‹å›¾")
            fig, ax = plt.subplots(figsize=(6, 6))
            p_energy = food['Protein_Value'] * 4
            f_energy = food['Fat_Value'] * 9
            ax.pie([p_energy, f_energy], labels=['Protein', 'Fat'], autopct='%1.1f%%', colors=['#2ecc71', '#e67e22'], startangle=90)
            st.pyplot(fig)
    else:
        st.warning("æ²¡æ‰¾åˆ°è¯¥é£Ÿç‰©ï¼Œå°è¯•æœç´¢å…¶ä»–åç§°å§ã€‚")
else:
    st.error("æœªå‘ç° protein_vs_fat.csvï¼Œè¯·ç¡®ä¿æ–‡ä»¶å·²ä¸Šä¼ åˆ°é¡¹ç›®æ ¹ç›®å½•ã€‚")
