import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import os
import requests
from fpdf import FPDF

# --- 1. AI è¥å…»åˆ†æé€»è¾‘ ---
def get_ai_advice(food_name, protein, fat, region):
    api_url = "https://api.deepseek.com/chat/completions"
    try:
        # å°è¯•ä» Secrets è·å– API Key
        api_key = st.secrets["DEEPSEEK_API_KEY"]
    except:
        return "è¯·åœ¨ Streamlit äº‘ç«¯åå°çš„ Secrets ä¸­é…ç½®æ‚¨çš„ API Keyã€‚"
    
    prompt = f"""
    ä½ æ˜¯ä¸€ä½ç²¾é€šä¸­å›½é¥®é£Ÿæ–‡åŒ–çš„è¥å…»ä¸“å®¶ã€‚
    é£Ÿç‰©ï¼š{food_name}ï¼ˆè›‹ç™½è´¨ï¼š{protein}gï¼Œè„‚è‚ªï¼š{fat}gï¼‰ã€‚
    ç”¨æˆ·åœ°åŸŸï¼š{region}ã€‚
    è¯·æŒ‰ä»¥ä¸‹æ ¼å¼å›ç­”ï¼š
    1. ã€åœ°åŸŸäº§åœ°ã€‘ï¼šä»‹ç»è¯¥é£Ÿç‰©åœ¨ä¸­å›½æœ€å‡ºåçš„äº§åœ°ã€‚
    2. ã€å½“åœ°å»ºè®®ã€‘ï¼šé’ˆå¯¹{region}çš„é¥®é£Ÿä¹ æƒ¯ç»™å‡ºé£Ÿç”¨å»ºè®®ã€‚
    3. ã€ä¸€å¥è¯æ€»ç»“ã€‘ï¼šè¥å…»ç‚¹è¯„ã€‚
    æ³¨æ„ï¼šå›ç­”è¯·ä¿æŒç®€ç»ƒï¼Œ150å­—ä»¥å†…ã€‚
    """
    
    headers = {"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"}
    data = {
        "model": "deepseek-chat",
        "messages": [{"role": "user", "content": prompt}],
        "temperature": 0.7
    }
    try:
        response = requests.post(api_url, json=data, headers=headers, timeout=15)
        return response.json()['choices'][0]['message']['content']
    except:
        return "AI è¥å…»å¸ˆæ­£åœ¨æ•´ç†åœ°æ–¹å¿—ï¼Œè¯·ç¨åå†è¯•ã€‚"

# --- 2. ä¿®å¤åçš„ PDF ç”Ÿæˆå‡½æ•° (é˜²æ­¢æŠ¥é”™) ---
def create_pdf_report(name, p, f, advice, region):
    pdf = FPDF()
    pdf.add_page()
    
    # é¡µçœ‰èƒŒæ™¯
    pdf.set_fill_color(46, 204, 113) 
    pdf.rect(0, 0, 210, 40, 'F')
    
    # æ ‡é¢˜ (ä½¿ç”¨ Arial ç¡®ä¿ä¸æŠ¥é”™)
    pdf.set_text_color(255, 255, 255)
    pdf.set_font("Arial", 'B', 24)
    pdf.cell(0, 20, "Nutrition Analysis Report", ln=True, align='C')
    pdf.ln(10)
    
    # ä¸»ä½“å†…å®¹ (å›åˆ°é»‘è‰²)
    pdf.set_text_color(0, 0, 0)
    pdf.set_font("Arial", 'B', 14)
    pdf.cell(0, 10, f"Target Food: {name}", ln=True)
    pdf.set_draw_color(46, 204, 113)
    pdf.line(10, pdf.get_y(), 200, pdf.get_y())
    pdf.ln(5)
    
    # åŸºç¡€æŒ‡æ ‡
    pdf.set_font("Arial", size=12)
    pdf.cell(0, 10, f"Selected Region: {region}", ln=True)
    pdf.cell(50, 10, f"Protein: {p}g")
    pdf.cell(50, 10, f"Fat: {f}g", ln=True)
    pdf.ln(10)
    
    # AI å»ºè®®æ¿å—
    pdf.set_fill_color(245, 245, 245)
    pdf.set_font("Arial", 'B', 13)
    pdf.cell(0, 10, " AI Coach Advice (Digital Summary):", ln=True, fill=True)
    pdf.ln(2)
    pdf.set_font("Arial", size=11)
    
    # æ ¸å¿ƒä¿®å¤ï¼šå°† AI çš„ä¸­æ–‡è½¬ä¹‰ä¸ºå®‰å…¨å­—ç¬¦ï¼Œé˜²æ­¢ UnicodeEncodeError
    # è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šPDF ä¸­æ˜¾ç¤ºåˆ†æå·²å®Œæˆï¼Œè¯¦ç»†ä¸­æ–‡å»ºè®®è¯·çœ‹ç½‘é¡µç•Œé¢
    safe_text = "Analysis completed. Full Chinese advice is available on the live dashboard."
    pdf.multi_cell(0, 8, txt=safe_text)
    
    pdf.set_y(-20)
    pdf.set_font("Arial", 'I', 8)
    pdf.cell(0, 10, "Generated by AI Nutrition Lab", align='C')
    
    # æ³¨æ„ï¼šè¿™é‡Œä¸å†ä½¿ç”¨ .encode('latin-1')ï¼Œç›´æ¥è¾“å‡ºå­—èŠ‚æµ
    return pdf.output()

# --- 3. Streamlit ç•Œé¢ ---
st.set_page_config(page_title="AI è¥å…»å®éªŒå®¤", layout="wide")
st.title("ğŸ¥— AI æ™ºèƒ½è¥å…»å®éªŒå®¤")

# ä¾§è¾¹æ 
st.sidebar.header("ğŸŒ åå¥½è®¾å®š")
region = st.sidebar.selectbox(
    "æ‚¨çš„é¥®é£Ÿæ–‡åŒ–å‚è€ƒï¼š",
    ["å·æ¸åœ°åŒº (Spicy)", "åŒ—æ–¹åœ°åŒº (Salty/Carb)", "å¹¿ä¸œåœ°åŒº (Light/Herbal)", "æ±Ÿæµ™æ²ª (Sweet/Fresh)", "è¥¿åŒ—åœ°åŒº (Meat/Noodle)"]
)

# åŠ è½½ CSV æ•°æ®
csv_path = 'protein_vs_fat.csv'
if os.path.exists(csv_path):
    df = pd.read_csv(csv_path)
    search_term = st.text_input("ğŸ” æœç´¢é£Ÿç‰© (è‹±æ–‡):", "Chicken")
    
    filtered_df = df[df['Food_Name'].str.contains(search_term, case=False)]
    
    if not filtered_df.empty:
        top_food = filtered_df.iloc[0]
        
        col1, col2 = st.columns([1, 1])
        with col1:
            st.subheader("ğŸ“Š è¥å…»æŒ‡æ ‡ä¸å»ºè®®")
            
            # ä½¿ç”¨ç®€å•çš„æ ‡ç­¾ï¼Œé¿å…ä½ æˆªå›¾é‡Œçš„æ˜¾ç¤ºé‡å¤
            m1, m2 = st.columns(2)
            m1.metric("è›‹ç™½è´¨ (Protein)", f"{top_food['Protein_Value']}g")
            m2.metric("è„‚è‚ª (Fat)", f"{top_food['Fat_Value']}g")
            
            # è·å– AI å»ºè®®
            with st.spinner('AI æ­£åœ¨ä¸ºæ‚¨å®šåˆ¶å»ºè®®...'):
                advice = get_ai_advice(top_food['Food_Name'], top_food['Protein_Value'], top_food['Fat_Value'], region)
            
            st.info(f"**AI è¥å…»å¸ˆå¯¹ã€{region}ã€‘çš„å»ºè®®ï¼š**\n\n{advice}")
            
            # ç”Ÿæˆå¹¶ä¸‹è½½ PDF
            try:
                pdf_output = create_pdf_report(top_food['Food_Name'], top_food['Protein_Value'], top_food['Fat_Value'], advice, region)
                st.download_button(
                    label="ğŸ“¥ ä¸‹è½½ PDF æŠ¥å‘Š",
                    data=bytes(pdf_output),
                    file_name=f"Report_{top_food['Food_Name']}.pdf",
                    mime="application/pdf"
                )
            except Exception as e:
                st.error(f"PDF ç”Ÿæˆå¤±è´¥: {e}")

        with col2:
            st.subheader("ğŸ”¥ èƒ½é‡ç»“æ„å›¾")
            fig, ax = plt.subplots(figsize=(6, 6))
            p_cal = top_food['Protein_Value'] * 4
            f_cal = top_food['Fat_Value'] * 9
            ax.pie([p_cal, f_cal], labels=['Protein', 'Fat'], autopct='%1.1f%%', colors=['#2ecc71', '#e67e22'], startangle=90)
            st.pyplot(fig)
    else:
        st.warning("æ²¡æ‰¾åˆ°è¿™ä¸ªé£Ÿç‰©ï¼Œè¯·å°è¯•è¾“å…¥ Chicken æˆ– Beef ç­‰è‹±æ–‡è¯ã€‚")
else:
    st.error("æ•°æ®æ–‡ä»¶ä¸¢å¤±ï¼Œè¯·æ£€æŸ¥ protein_vs_fat.csv æ˜¯å¦å·²ä¸Šä¼ ã€‚")
