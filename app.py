import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import os
import requests
from fpdf import FPDF

# --- 1. AI è¥å…»åˆ†æé€»è¾‘ ---
def get_ai_advice(food_name, protein, fat, region):
    api_url = "https://api.deepseek.com/chat/completions"
    try:
        # è·å– Secrets ä¸­çš„ Key
        api_key = st.secrets["DEEPSEEK_API_KEY"]
    except:
        return "è¯·åœ¨ Streamlit Secrets ä¸­é…ç½® API Key ğŸ”‘"
    
    prompt = f"""
    ä½ æ˜¯ä¸€ä½ç²¾é€šä¸­å›½é¥®é£Ÿæ–‡åŒ–çš„è¥å…»ä¸“å®¶ã€‚
    é£Ÿç‰©ï¼š{food_name}ï¼ˆè›‹ç™½è´¨ï¼š{protein}gï¼Œè„‚è‚ªï¼š{fat}gï¼‰ã€‚
    åœ°åŸŸä¹ æƒ¯ï¼š{region}ã€‚
    è¯·æä¾›ï¼š1.è¯¥é£Ÿç‰©çš„ä¸­å›½åäº§åœ°ï¼›2.é’ˆå¯¹{region}äººç¾¤çš„å»ºè®®ï¼›3.ä¸€å¥è¯ç‚¹è¯„ã€‚
    è¦æ±‚ï¼šä¸­æ–‡å›ç­”ï¼Œ150å­—ä»¥å†…ã€‚
    """
    
    headers = {"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"}
    data = {
        "model": "deepseek-chat",
        "messages": [{"role": "user", "content": prompt}],
        "temperature": 0.7
    }
    try:
        response = requests.post(api_url, json=data, headers=headers, timeout=15)
        return response.json()['choices'][0]['message']['content']
    except:
        return "AI æ­£åœ¨æ€è€ƒä¸­ï¼Œè¯·ç¨ååˆ·æ–°é¡µé¢..."

# --- 2. ç¨³å®šç‰ˆ PDF ç”Ÿæˆå‡½æ•° (é¿å…å­—ç¬¦æŠ¥é”™) ---
def create_pdf_report(name, p, f, region):
    pdf = FPDF()
    pdf.add_page()
    
    # é¡¶éƒ¨è£…é¥°æ¡ï¼šè–„è·ç»¿
    pdf.set_fill_color(46, 204, 113) 
    pdf.rect(0, 0, 210, 40, 'F')
    
    # æ ‡é¢˜ (è‹±æ–‡ï¼Œé¿å… Unicode æŠ¥é”™)
    pdf.set_text_color(255, 255, 255)
    pdf.set_font("helvetica", 'B', 24)
    pdf.cell(0, 20, "Nutrition Analysis Report", ln=True, align='C')
    pdf.ln(10)
    
    # å†…å®¹ä¸»ä½“
    pdf.set_text_color(0, 0, 0)
    pdf.set_font("helvetica", 'B', 14)
    pdf.cell(0, 10, f"Food Analysis: {name}", ln=True)
    pdf.set_draw_color(46, 204, 113)
    pdf.line(10, pdf.get_y(), 200, pdf.get_y())
    pdf.ln(5)
    
    # æ•°æ®å±•ç¤º
    pdf.set_font("helvetica", size=12)
    pdf.cell(0, 10, f"User Region Preset: {region}", ln=True)
    pdf.cell(50, 10, f"Protein: {p}g")
    pdf.cell(50, 10, f"Fat: {f}g", ln=True)
    pdf.ln(10)
    
    # æç¤ºä¿¡æ¯
    pdf.set_fill_color(245, 245, 245)
    pdf.set_font("helvetica", 'B', 12)
    pdf.cell(0, 10, " AI Coach Notice:", ln=True, fill=True)
    pdf.set_font("helvetica", size=10)
    notice = (
        "The customized Chinese analysis has been generated on your dashboard. "
        "Due to PDF encoding standards, please view the full regional advice "
        "and sourcing details on the live application page."
    )
    pdf.multi_cell(0, 8, txt=notice)
    
    pdf.set_y(-20)
    pdf.set_font("helvetica", 'I', 8)
    pdf.cell(0, 10, "Generated by AI Nutrition Lab", align='C')
    
    return pdf.output()

# --- 3. Streamlit é¡µé¢ä¸»ç¨‹åº ---
st.set_page_config(page_title="AI è¥å…»å®éªŒå®¤", layout="wide")
st.title("ğŸ¥— AI æ™ºèƒ½è¥å…»å®éªŒå®¤")

# ä¾§è¾¹æ åœ°åŸŸé€‰æ‹©
st.sidebar.header("ğŸŒ åœ°åŸŸåå¥½")
region_option = st.sidebar.selectbox(
    "æ‚¨çš„é¥®é£ŸèƒŒæ™¯ï¼š",
    ["Sichuan/Chongqing (Spicy)", "North China (Salty)", "Guangdong (Light)", "Jiangsu/Zhejiang (Sweet)"]
)

csv_file = 'protein_vs_fat.csv'
if os.path.exists(csv_file):
    df = pd.read_csv(csv_file)
    query = st.text_input("ğŸ” æœç´¢é£Ÿç‰©åç§° (å¦‚ Beef):", "Chicken")
    
    res = df[df['Food_Name'].str.contains(query, case=False)]
    
    if not res.empty:
        food = res.iloc[0]
        col1, col2 = st.columns([1, 1])
        
        with col1:
            st.subheader("ğŸ“Š è¥å…»æŒ‡æ ‡ä¸ AI å»ºè®®")
            # ä¿®å¤æ˜¾ç¤ºé‡å¤çš„ Bug
            c1, c2 = st.columns(2)
            c1.metric("è›‹ç™½è´¨ (Protein)", f"{food['Protein_Value']}g")
            c2.metric("è„‚è‚ª (Fat)", f"{food['Fat_Value']}g")
            
            with st.spinner('æ­£åœ¨è°ƒå–åœ°åŸŸè¥å…»æ•°æ®åº“...'):
                advice = get_ai_advice(food['Food_Name'], food['Protein_Value'], food['Fat_Value'], region_option)
            
            st.info(f"**AI è¥å…»å¸ˆå»ºè®®ï¼š**\n\n{advice}")
            
            # PDF ä¸‹è½½
            try:
                # ä¼ å…¥è‹±æ–‡åä»¥é˜²æŠ¥é”™
                report_pdf = create_pdf_report(food['Food_Name'], food['Protein_Value'], food['Fat_Value'], region_option)
                st.download_button(
                    label="ğŸ“¥ ä¸‹è½½ä¸“ä¸šè¥å…»æŠ¥å‘Š (PDF)",
                    data=bytes(report_pdf),
                    file_name=f"Report_{food['Food_Name']}.pdf",
                    mime="application/pdf"
                )
            except Exception as e:
                st.error(f"PDF å¯¼å‡ºå¤±è´¥: {e}")

        with col2:
            st.subheader("ğŸ”¥ èƒ½é‡ä¾›èƒ½æ¯”")
            fig, ax = plt.subplots(figsize=(6, 6))
            p_energy = food['Protein_Value'] * 4
            f_energy = food['Fat_Value'] * 9
            ax.pie([p_energy, f_energy], labels=['Protein', 'Fat'], autopct='%1.1f%%', colors=['#2ecc71', '#e67e22'], startangle=140)
            st.pyplot(fig)
    else:
        st.warning("æœªæ‰¾åˆ°åŒ¹é…é£Ÿç‰©ã€‚")
else:
    st.error("æ•°æ®æ–‡ä»¶ä¸¢å¤±ã€‚")
